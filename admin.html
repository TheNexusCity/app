<!doctype html>
<html>
<body>
  <form id=mint-parcels-form>
    <h1>Mint parcels</h1>
    <div>
      <a href="https://webaverse.github.io/parcels/parcels.json">parcels.json on Github</a>
    </div>
    <textarea id=parcels-json-input cols=80 rows=16 placeholder="paste parcels.json"></textarea>
    <input type=submit value="Mint">
  </form>
<!-- <script src="./bin/geometry.js"></script> -->
<script type=module>
import * as THREE from './three.module.js';
// import {GLTFLoader} from './GLTFLoader.js';
// import {GLTFExporter} from './GLTFExporter.js';
// import {makePromise, downloadFile, convertMeshToPhysicsMesh} from './util.js';
import {loginManager} from './login.js';
import {web3, contracts, runSidechainTransaction} from './blockchain.js';

const mintParcelsForm = document.getElementById('mint-parcels-form');
const parcelsJsonInput = document.getElementById('parcels-json-input');
mintParcelsForm.addEventListener('submit', async e => {
  e.preventDefault();
  e.stopPropagation();
  
  // const ethereumSpec = await window.ethereum.enable();
  // const [address] = ethereumSpec;

  await loginManager.waitForLoad();
  const mnemonic = await loginManager.getMnemonic();
  const address = await loginManager.getAddress();

  const parcelsJsonString = parcelsJsonInput.value;
  const parcelsJson = JSON.parse(parcelsJsonString);
  // console.log('got parcels json', parcelsJson, address);
  if (Array.isArray(parcelsJson)) {
    for (let i = 0; i < parcelsJson.length; i++) {
      const parcelJson = parcelsJson[i];
      const {name, rarity, extents} = parcelJson;

      let tokenId;
      try {
        const result = await runSidechainTransaction(mnemonic)('LAND', 'mintSingle', address, name);
        console.log('got mint result 1', result);
        tokenId = new web3.sidechain.utils.BN(result.logs[0].topics[3].slice(2), 16).toNumber();
      } catch(err) {
        tokenId = i + 1;
        console.warn(err);
      }
      const hash = await contracts.sidechain.LAND.methods.getHash(tokenId).call();
      console.log('got hash', [tokenId, hash]);
      {
        const result2 = await runSidechainTransaction(mnemonic)('LAND', 'setMetadata', hash, 'rarity', rarity);
        console.log('got mint result 2', result2);
      }
      {
        const result3 = await runSidechainTransaction(mnemonic)('LAND', 'setMetadata', hash, 'extents', JSON.stringify(extents));
        console.log('got mint result 3', result3);
      }
      /* await contracts.sidechain.LAND.methods.mintSingle(address, name).send({
        from: address,
      }); */
    }
  } else {
    throw new Error('input is not an array', parcelsJson);
  }
});

</script>
</body>
</html>

<html>
<head>
  <title>Webaverse Map</title>
  <link rel=stylesheet type='text/css' href="map.css">
</head>
<body>
  <div id=container></div>

  <script src="./bin/geometry.js"></script>
<script type=module>
  import * as THREE from './three.module.js';
  import App from './app.js';
  import {camera, orthographicCamera, renderer} from './app-object.js';
  import {world} from './world.js';
  // import {homeScnUrl} from './constants.js';

  const width = 128;
  const height = 128;
  const cameraPosition = new THREE.Vector3(0, 100, -2);
  const cameraTarget = new THREE.Vector3(cameraPosition.x + 1, 0, cameraPosition.z - 5);

  /* const renderer = new THREE.WebGLRenderer({
    alpha: true,
    antialias: true,
  });
  renderer.setSize(width, height);

  const scene = new THREE.Scene();

  const directionalLight = new THREE.DirectionalLight(0xFFFFFF, 1);
  directionalLight.position.set(2, 2, -2);
  scene.add(directionalLight);
  const directionalLight2 = new THREE.DirectionalLight(0xFFFFFF, 1);
  directionalLight2.position.set(-2, 2, 2);
  scene.add(directionalLight2); */
  
  renderer.setSize(width, height);
  renderer.setPixelRatio(2);

  camera.aspect = width/height;
  camera.updateProjectionMatrix();
  camera.up.set(0, 0, -1);

  orthographicCamera.left = -5;
  orthographicCamera.right = 5;
  orthographicCamera.top = 5;
  orthographicCamera.bottom = -5;
  orthographicCamera.near = 0;
  orthographicCamera.far = 1000;
  orthographicCamera.updateProjectionMatrix();
  camera.projectionMatrix.copy(orthographicCamera.projectionMatrix);

  (async () => {
    const app = new App();
    await app.waitForLoad();

    await world.addObject(`https://webaverse.github.io/street/index.js`, null, new THREE.Vector3(), new THREE.Quaternion());
    
    // const renderer = app.getRenderer();
    // const camera = new THREE.OrthographicCamera();

    setTimeout(() => {
      // document.body.appendChild(renderer.domElement);

      for (let x = -10; x < 10; x++) {
        for (let z = -10; z < 10; z++) {
          const v = new THREE.Vector3(x * 10, 0, z * 10);
          camera.position.copy(cameraPosition).add(v);
          camera.lookAt(cameraTarget.clone().add(v));

          renderer.clear();
          app.render();
        
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          canvas.style.position = 'absolute';
          canvas.style.left = ((10 + x)*width) + 'px';
          canvas.style.top = ((10 + z)*height) + 'px';
          const ctx = canvas.getContext('2d');
          ctx.drawImage(renderer.domElement, 0, 0, canvas.width, canvas.height);
          document.body.appendChild(canvas);
        }
      }
    }, 1000);

    /* if (dst) {
      fetch(dst, {
        method: 'POST',
        headers: {
          'Content-Type': mimeType,
        },
        body: arrayBuffer,
      }).then(res => res.blob());
    }

    window.parent.postMessage({
      method: 'result',
      result: arrayBuffer,
    }, '*', [arrayBuffer]); */
  })();
</script>
</body>

</html>

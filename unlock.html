<!doctype html>
<html>
<body>
  <form id=unlocks-form>
    <h1>Mainnet unlocks</h1>
    <div id=mainnet-unlocks></div>
    <h1>Sidechain unlocks</h1>
    <div id=sidechain-unlocks></div>
    <input type=submit value="Check" id=submit-button>
  </form>
<!-- <script src="./bin/geometry.js"></script> -->
<script type=module>
import * as THREE from './three.module.js';
// import {GLTFLoader} from './GLTFLoader.js';
// import {GLTFExporter} from './GLTFExporter.js';
// import {makePromise, downloadFile, convertMeshToPhysicsMesh} from './util.js';
import {loginManager} from './login.js';
import Web3 from './web3.min.js';
import bip39 from './bip39.js';
import hdkeySpec from './hdkey.js';
const hdkey = hdkeySpec.default;
import {web3, contracts, getNetworkName, getMainnetAddress, runSidechainTransaction, runMainnetTransaction} from './blockchain.js';

const unlocksForm = document.getElementById('unlocks-form');
const submitButton = document.getElementById('submit-button');

(async () => {
  await loginManager.waitForLoad();
  
  window.Web3 = Web3;
  window.mainnet = web3.mainnet;
  window.mainnetsidechain = web3.mainnetsidechain;

  submitButton.removeAttribute('disabled');
  unlocksForm.addEventListener('submit', async e => {
    e.preventDefault();
    e.stopPropagation();
    
    // const ethereumSpec = await window.ethereum.enable();
    // const [address] = ethereumSpec;

    const mnemonic = await loginManager.getMnemonic();
    const address = await loginManager.getAddress();

    if (window.ethereum) {
      const m = "Proof of address.";
      /* const result1 = await window.ethereum.enable();
      const result2 = await web3.mainnet.eth.personal.sign(m, web3.mainnet.currentProvider.selectedAddress);
      const result3 = await web3.mainnet.eth.personal.ecRecover(m, result2); */

      const wallet = hdkey.fromMasterSeed(bip39.mnemonicToSeedSync(mnemonic)).derivePath(`m/44'/60'/0'/0/0`).getWallet();
      const privateKey = wallet.getPrivateKey().toString('hex');

      console.log('log', [m, privateKey]);
      const result2 = await web3.mainnetsidechain.eth.accounts.sign(m, privateKey);
      console.log('log 2', result2);
      const {v, r, s, signature} = result2;
      const result3 = await web3.mainnetsidechain.eth.accounts.recover(m, v, r, s);
      console.log('got result', {result2, result3});
      
      const id = 82;
      
      const res = await fetch('https://unlock.exokit.org/', {
        method: 'POST',
        body: JSON.stringify({
          signature,
          id,
        }),
      });
      const j = await res.json();
      
      console.log('got j', j);
    }
  });
})();

</script>
</body>
</html>
